---
title: 典中典之 一次渗透经历
published: false
---

这是过于典型的web渗透例子，没有用0day和通杀打. 虽然网上到处都是这种没什么意义的"记一次内网渗透""记一次外网渗透"，但是一想自己如果不发这种典中典文章还是不好，毕竟俗话说祖宗之法不可变. 因此就发出来了  

# [](#header-1)0、前言

这是一次对高等学校教育资产的渗透测试经历，总体而言并不有趣，并未涉及到某些出人意料的操作  
后面内网部分，等以后有时间了再更  

# [](#header-1)1、前期资产搜集

前期还是先大规模资产搜集，各种暴力搜集框架 + 人肉搜集跑两天再说  
把所有的资产都整理出来，边继续搜集边测试漏洞

# [](#header-1)2、前期漏洞探寻

在资产搜集时，发现该edu域下某子域名(为了方便我们以xxxx.edu.cn代替主域名)randname.xxxx.edu.cn疑似泄漏数据库信息  

原理是：  
该站点为某vue前后端分离式站点(感觉像是大学生写的)，后端与前端放于同一web服务根路径，通过大量fuzz发现后端存在某隐蔽的疑似废弃接口  

访问该接口时，后端某中间件会报错，直接在响应中爆出了stack中各种中间件爆出的大量debug信息，包括stack中涉及到的应用框架、数据库信息及vue route信息  

在这大量debug信息中，最有价值的信息就是  
```
数据库类型：mysql  
ip：219.221.*.*  
端口：3306  
用户名：*
密码信息：*  
```
该ip是属于该校的教育网段，地址是中国四川省**市，其端口未向外提供任何mysql服务，  
推测该ip仅在学校内网开放端口，并且该站点randname.xxxx.edu.cn是站库分离型站点，只能暂时先搁置  

于是我们接下来放一部分重心在发现能穿进内网连数据库的通杀或各类数据库管理面板中，一般该类数据库管理面板是后端连接数据库，可以利用这种特性穿进内网 

继续搜集了两天资产信息，终于获得了一个phpmyadmin站点，但却无法登录该数据库。根据域名C类解析结果初步推测该站点为外部搭建的站点，独立于学校段  

后面陆陆续续搜集到了一些小洞，但都无法getshell. 正当后面快放弃时，突然在后续某一天搜集过程中，发现该校某开源项目站点资产下的路径挂了个数据库管理站点  
并且该站点允许自定义内网ip连接，如下所示
```
Adminer 4.7.7
Login
__________________________________________
|  System: Mysql
|  Server: 127.0.0.1
|  Username: 
|  Password:
|  Database:
|_________________________________________
_______
|Login|      √ Permanently Login
|_____|
```

在之前其实就发现了该开源项目搭建的站点，但在github上该项目仓库找了一圈issue发现并没有通杀和弱密码可用后，就暂时没管，没曾想该校工作人员在搭建项目时加了个数据库管理面板在项目根路径下  

尝试着登录没想到竟然成功登录，该用户连接能爆大量数据库并查出数据. 数据库面板泄露是十分正常的事，可疑的数据库用户名和密码泄露也是十分正常的事，这两件事合在一起就十分不正常了

# [](#header-1)3、数据库分析

搜集一下关于该用户连接能查到大概三十多个库的上十万名学生数据，包括身份证信息、家庭住址、常用密码的bcrypt加密值，真是令人震惊！

并且据我资产搜集所知，该校一直有自己的网络安全实验室，我相信就算是浅测一下也不至于有那么大的问题  

回归正题，再按创建时间排序查看该数据库服务器中所有数据库中最近创建的表  
```sql
SELECT * FROM INFORMATION_SCHEMA.TABLES ORDER BY create_time DESC; 
```
发现最近的表是在2023年创建的，而最早表是2003年创建的  
经过验证，确实发现部分新数据库内有该校2022年入学的学生，是一个运行了很久的数据库服务器  
不过再仔细观察发现，这些表中并没有教务处人员、 教务处等信息，因此推测该服务并非主要服务，想要更深入就得进内网  

# [](#header-1)4、中期进内网尝试

一开始本来想通过mysql提权  
但该用户权限不高：其他数据库查权限 + 本数据库增查改删权限，无into FILE权限及slow-log权限，常规提权无法操作  
且该mysql服务版本为：5.7.32-log，于2020-10-19日发布，距今仅有部分小ddos通杀，看来无从下手~~除非能找到mysql漏洞~~  

但我们已经有了大量学生学号信息 + 常用密码bcrypt值，且由资产搜集情报得知该校默认密码为身份证后六位，也就是说只需要在同一bcrypt hash下跑30万次即可猜出某位默认密码账号的密码，如果已知学生生日、性别、出生地辖区等更多信息，那可以浅优化到500次  

身份证号规则：  
<table style="border:1px solid #2bbc8a;border-collapse: collapse" border="1">
  <tr>
    <td>1</td>
    <td>2</td>
    <td>3</td>
    <td>4</td>
    <td>5</td>
    <td>6</td>
    <td>7</td>
    <td>8</td>
    <td>9</td>
    <td>10</td>
    <td>11</td>
    <td>12</td>
    <td>13</td>
    <td>14</td>
    <td>15</td>
    <td>16</td>
    <td>17</td>
    <td>18</td>
  </tr>
  <tr>
    <td colspan="2">省码</td>
    <td colspan="2">市码</td>
    <td colspan="2">区县码</td>
    <td colspan="4">年</td>
    <td colspan="2">月</td>
    <td colspan="2">日[1]</td> 
    <td colspan="2">县区所辖派出所码</td>
    <td colspan="1">男女码[2]</td>
    <td colspan="1">校验码</td>
  </tr>
  <tr>
  	<td colspan="6">地址码</td>
    <td colspan="8">出生日期</td>
    <td colspan="3">出生顺序码[3]</td>
    <td colspan="1">校验码</td>
  </tr>
  <tr>
  	<td colspan="17">数字本体码</td>
    <td colspan="1">校验码</td>
  </tr>
  <tr>
    <td colspan="18">中华人民共和国居民身份证</td>
  </tr>
</table>

[1]28 <= max(日) <= 31  
[2]男女码由县区所辖派出所制定，男单女双，每个县区所辖派出所当日必须按0 -> 9的顺序为新生人口指定身份证男女码  
[3]999、998、997、996四个出生顺序码专为男女性百岁以上公民编号  

参考来源:
1. ^[中华人民共和国行政区划代码](https://baike.baidu.com/reference/19623128/b38dnXYyG2z7r0fhaUijHzJpuy6BTe6wFznj8jqkLBYusfb6emv8v3DV-PnOu0Rbw-ic2kP1m0Vl7i36am84NPXMGtskirr_FMxutthnK6QzvLxBu1QTrRufM4ayHg)[2020-03-23]
2. ^中华人民共和国国家标准GB11643-1999有关公民身份号码的规定[2020-03-23]

接下来vpn成功进学校  

# [](#header-1)5、中期内网渗透

初步判断该校校园网是迅捷的设备  
由于本人不是很会内网渗透，只会拿着各种b段c段扫了一遍后，nmap、masscan扫一遍看看开了什么服务，nessus看一遍  
虽然确实扫到了不少校内网页资产，但都很常规  

根据扫描发现，172.21.0.0 - 172.24.255.25 该ip范围内有大量活动设备  

使用github上前两天看到的开源摄像头扫描工具Ingram先测测，这个工具很方便，集成了CVE-2021-33045、CVE-2021-33044等摄像头漏洞  
发现有不少hikvision设备  
```
172.21.1.200,80,hikvision
172.21.1.202,80,hikvision
172.21.1.201,80,hikvision
172.21.3.0,8888,dvr
172.21.3.3,8888,dvr
172.21.24.14,80,dahua
172.21.24.13,80,dahua
172.21.24.12,80,dahua
172.21.24.11,80,dahua
172.21.24.16,80,dahua
172.21.24.15,80,dahua
172.21.69.200,8081,dvr
172.21.144.8,8888,dvr
172.21.145.131,8888,dvr
```
但基本上都是改了默认密码，且更新了程序，毕竟各种攻防演练也不是白组织的  

以后再更


